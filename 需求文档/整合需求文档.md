# ACFUN直播工具箱整合需求文档（字节跳动标准）

## 一、项目概述
ACFUN直播工具箱是一款基于Electron开发的跨平台直播辅助工具，支持Windows、macOS和Linux系统。工具采用"应用主程序+小程序"架构，主程序提供稳定可靠的核心直播管理功能，小程序系统提供丰富多样的扩展能力，为ACFUN直播平台的主播提供高效、灵活的直播辅助解决方案。

### 1.1 产品定位
- **目标用户**：ACFUN平台主播（个人主播、机构主播、签约主播）
- **核心价值**：简化直播流程、增强观众互动、提供数据洞察、支持功能扩展
- **产品形态**：桌面应用程序（Electron）+小程序生态
- **技术架构**：分层架构设计，主进程+渲染进程+小程序沙箱环境

### 1.2 核心优势
- **开源免费**：降低主播使用门槛，支持社区贡献
- **跨平台支持**：覆盖主流操作系统，满足不同主播的设备需求
- **模块化设计**：核心功能稳定可靠，扩展功能灵活可选
- **性能优化**：针对直播场景优化资源占用，确保直播流畅性
- **安全可控**：完善的权限管理机制，保障直播内容安全

### 1.3 后端技术架构

#### 1.3.1 总体架构
ACFUN直播工具箱后端采用分层架构设计，基于Electron框架实现跨平台支持,采用模块化设计理念,将核心功能与扩展能力分离。

- **核心层**:包含应用基础模块、配置管理、日志系统等基础设施
- **服务层**:实现弹幕处理、推流管理、小程序系统等核心业务功能
- **API层**:提供统一的接口供渲染进程和小程序调用
- **通信层**:处理进程间通信、网络请求和实时数据流

#### 1.3.2 技术栈
- 基础框架:Electron
- 语言:TypeScript
- 服务器:Express
- 进程通信:IPC、WebSocket、EventSource
- 数据存储:本地文件系统、electron-data

### 1.3.3 核心模块设计

#### 应用生命周期管理

#####模块系统
应用模块接口定义了标准化的模块启用方法，所有模块需实现enable接口以接收上下文信息并完成初始化。

- ModuleRunner负责初始化和管理所有应用模块

#####初始化流程
应用初始化流程通过模块运行器依次加载核心功能模块，包括单实例控制、窗口生命周期管理、硬件加速配置、自动更新和弹幕系统等，确保各组件按序完成初始化。

#### 弹幕系统模块
- 采用子进程模式运行,确保弹幕处理不影响主进程稳定性
- 支持WebSocket和TCP两种连接模式,提高连接可靠性
- 提供完整的配置管理和日志收集机制
- 实现弹幕流接收、存储、分发。支持同时接收/分发多个直播间弹幕流。

核心实现代码示例:
弹幕系统模块包含存储和分发逻辑：存储逻辑将全量弹幕保存到sqlite数据库中，支持增量更新。分发逻辑根据收到的直播间ID将弹幕分发给对应的小程序。设置超时机制，如果弹幕对应的直播间ID不属于登陆者本人，则在一段时间没有小程序请求该直播间弹幕之后关闭对应直播间ID弹幕流

**核心API接口:**
- `GET /api/danmu/connect`: 建立弹幕连接
- `GET /api/danmu/disconnect`: 断开弹幕连接
- `GET /api/events/danmu`: 获取实时弹幕流(SSE)
- `GET /api/danmu/history`: 获取历史弹幕
- `GET /api/danmu/config`: 获取弹幕配置
- `POST /api/danmu/config`: 更新弹幕配置

**对应需求:**
- 性能需求: 弹幕处理能力≥1000条/秒
- 功能验收: 弹幕显示准确率≥99%,过滤规则生效时间≤1秒

#### 窗口管理
- 基于Electron BrowserWindow实现
- 用于管理支持窗口打开的小程序窗口
- 支持多窗口管理和窗口间通信
- 延迟初始化机制确保IPC事件处理器已注册
- 窗口创建和配置分离,通过WindowOptions接口实现灵活配置
- 支持窗口状态持久化(位置、大小、最大化状态)

#### 小程序管理
- 实现应用生命周期管理
- 支持模块化加载和卸载
- 提供小程序配置持久化存储

小程序管理器采用事件驱动架构，通过扫描指定目录加载小程序配置，维护小程序注册表和窗口映射关系，提供小程序生命周期管理和跨进程通信能力。

### 1.3.4 通信机制

#### 进程间通信
- 使用Electron的ipcMain和ipcRenderer实现主进程与渲染进程通信
- 定义标准化的API接口,支持异步调用和错误处理

进程间通信API采用Electron的ipcMain机制实现，提供弹幕模块启停等核心功能的跨进程调用接口，包含错误处理和状态返回机制。

#### 实时数据流
- 使用EventSource实现单向实时数据流(如弹幕流)
- 支持心跳机制和断线重连策略
- 基于HTTP长连接,减少资源消耗

HTTP服务器模块实现了基于EventSource的服务器推送功能，通过建立持久连接向客户端推送实时事件数据流，包含连接管理、事件发布和资源清理机制。

### 1.3.5 存储系统设计

#### 配置管理
- 基于electron-data实现跨平台配置存储
- 支持配置文件备份和恢复
- 配置变更实时生效机制
配置管理器基于electron-data实现跨平台配置存储，支持自定义路径、自动保存和格式化存储，提供配置目录创建、初始化和错误处理功能。

####数据管理
- 单例模式实现的数据管理器
- 支持应用数据的CRUD操作
- 数据变更通知机制

数据管理器采用单例模式设计，提供键值对数据存储和变更通知机制，支持数据监听和事件驱动的数据更新，确保应用状态一致性。

#### 日志系统
- 基于EventEmitter实现的日志管理器
- 支持多来源日志分类管理
- 文件日志(按日期轮转)和内存日志(限制1000条)双存储机制
- 日志级别控制(info/debug/error/warn)

日志管理器基于事件驱动架构，实现多来源日志分类管理，采用文件日志（按日期轮转）和内存日志（限制1000条）双存储机制，支持日志级别控制和日志添加事件通知。

### 1.3.6 HTTP服务器与API设计

#### 服务器架构
- 基于Express实现的轻量级HTTP服务器
- 支持静态资源托管和API路由
- 动态路由注册机制,支持模块化扩展

HTTP服务器管理模块基于Express框架构建轻量级服务器，支持静态资源托管和API路由，实现动态路由注册机制和模块化扩展，提供服务器初始化和端口配置功能。

#### API设计原则
- RESTful API设计风格
-统一的响应格式({success: boolean, data?: any, error?: string})
-完善的错误处理
-权限验证机制

### 1.3.7 性能优化策略

#### 资源管理
- 子进程隔离CPU密集型任务(弹幕处理≥1000条/秒)
- 延迟加载非核心模块(首屏加载≤3个核心模块)
- 资源使用限制(单小程序内存≤100MB,CPU占用≤5%)
- 实现代码:
性能优化采用子进程隔离机制处理CPU密集型任务，如弹幕处理（≥1000条/秒），通过设置5MB缓冲区限制和独立进程资源，避免影响主进程稳定性。

#### 网络优化
- 请求合并减少网络往返(批量API请求合并≤100ms延迟)
- 数据缓存策略(内存缓存TTL=5分钟,磁盘缓存TTL=24小时)
- 长连接复用(WebSocket连接池大小=5,EventSource复用率≥90%)

#### 渲染优化
- 虚拟列表处理大数据渲染(弹幕列表可视区域渲染≤50条)
- 图片懒加载和压缩(WebP格式,质量70%,预加载视口内图片)
- 避免不必要的重绘(使用CSS containment,减少DOM操作)
- 避免不必要的UI更新

### 1.3.8 安全性设计

- 主进程与渲染进程严格隔离
- 小程序运行在独立沙箱中
- 敏感数据加密存储
- 直播码定期刷新
- IPC通信权限验证

### 1.3.9 小程序设计

#### 1.3.9.1 模块系统
- 标准化的AppModule接口
- 动态模块加载机制
- 模块依赖管理

#### 1.3.9.2 小程序架构
- 小程序运行时环境
- 标准化通信接口
- 资源限制和安全沙箱

#### 1.3.9.3 小程序系统
- **插件注册机制**: 基于manifest.json声明式注册，支持静态和动态注册
小程序系统采用声明式注册机制，通过manifest.json定义插件元数据和钩子函数，支持静态和动态注册，实现小程序启动/关闭、直播开始/结束等关键节点的功能扩展。
- **钩子函数扩展点**: 主程序启动/关闭、直播开始/结束、弹幕接收等关键节点
- **插件生命周期管理**: 加载→初始化→激活→停用以→卸载，支持热重载

### 1.3.10 部署与构建

#### 1.3.10.1 构建流程
- TypeScript编译
- 资源打包
- 代码压缩和优化

#### 1.3.10.2 自动更新
- 增量更新机制
- 更新检测和通知
- 回滚策略

#### 1.3.10.3 版本管理
- 语义化版本控制
- 版本兼容性保证
- 版本发布流程



### 1.2 前端技术架构

#### 1.2.1 总体架构
ACFUN直播工具箱前端采用组件化、模块化架构设计,基于Vue+TypeScript+TDesign实现,遵循MVVM模式

#### 1.2.2 组件设计
- 基础组件:按钮输入框、选择器等高复用组件
- 功能组件:弹幕组件、直播数据卡片等特殊业务组件
- 页面组件:登录页、仪表盘等完整页面

### 1.2.3 功能模块实现方案

#### 1.2.3.1 主客户端核心模块

##### 仪表盘模块
-数据获取:通过userProfile接口获取用户信息
-状态管理:使用状态管理工存储用户信和核心数据
- 动态内容渲染：根据数据类型动态渲染不同内容块

##### 用户认证模块
-登录流程:生成登录二维码、监听扫描状态、验证登录信息、存储用户会话
-状态管理:使用状态管理工具管理登录状态、浏览器存储持久化
-权限控制:路由守卫、组件级别权限控制

##### 直播管理模块
房间管理:房间信CRUD操作、封面上传裁剪分区选择
-推流管理:RTMP地址直播码管理OB连接状态监控
-信息展:实时观众数、点赞数、香蕉数等统计数据

#### 1.2.3.2 小程序系统模块

##### 1.2.3.2.1 小程序开发者支持
- 提供完整的API文档和开发指南
- 开发调试工具集成
- 小程序打包和发布流程支持
- 版本管理和兼容性测试工具

##### 1.2.3.2.2 小程序管理
-小程序加载机制:动态加载远程组件、权限验证、生命周期管理
-小程序状态监控:实时监控运行状态、资源使用情况、性能指标
-小程序权限管理:细粒度权限控制、API访问限制、数据隔离

##### 1.2.3.2.3 小程序市场
小程序商店:分类展示、搜索功能、评分系统
安装更新:一键安装、自动更新、版本回退
- 安全性检测:代码扫描、权限审计、运行时监控

### 1.2.4 核心功能实现细节

#### 1.2.4.1 状态管理设计
使用状态管理工具Pinia进行全局状态管理
模块化设计分离不同功能域的状态
派生计算状态
处理异步操作
修改状态的规范方法

#### 1.2.4.2 网络请求设计
封装HTTP请求
实现EventSource连接管理用于处理单向数据流
请求拦截器添加认证信息
响应拦截器处理错误
请求重试机制

#### 1.2.4.3 组件通信机制
父子组件通过props事件通信
跨组件通信使用事件总线
全局状态通过状态管理工具共享
小程序与主应用通过定制事件通信

#### 1.2.4.4 性能优化策略
组件懒加载
图片懒加载和压缩
虚拟列表处理大数据渲染
防抖节流处理频繁操作
缓存策略减少重复请求

### 1.3 部署与构建

#### 1.3.1 构建流程
-TypeScript编译
-资源打包
-代码压缩和优化

#### 1.3.2 自动更新
-增量更新机制
-更新检测和通知
-回滚策略

#### 1.3.3 版本管理
-语义化版本控制
-版本兼容性保证
-版本发布流程


## 二、用户核心诉求分析

- **新手主播**：需要简单易用的开播流程，基础弹幕管理功能
- **成长型主播**: 需要数据分析功能，观众互动工具，直播效果优化建议
- **资深主播**: 需要高度自定义能力，多平台整合，专业级数据洞察
  
### 2.2 用户痛点与需求
- **开播准备复杂**: 希望简化开播流程，一键完成房间设置和推流配置
- **互动管理困难**: 需要高效弹幕过滤工具，自定义互动规则
- **功能扩展受限**: 需要灵活添加新功能，无需等待整体版本更新
- **数据决策缺失**: 需要直观的直播数据展示，观众行为分析
- **多平台管理繁琐**: 希望一站式管理多个直播平台和账号
## 三、UI设计需求
### 3.1 UI整体架构
ACFUN直播工具箱采用分层架构设计，整体风格为深色主题，符合直播工具的专业感和夜间使用场景需求。UI设计遵循"主客户端聚焦核心，小程序扩展功能"的架构理念，通过清晰的视觉层次和交互设计区分核心功能与扩展功能。

#### 3.1.1 布局层次
- **应用层**：基于跨平台应用框架，包含主客户端和小程序容器
- **框架层**：自定义的布局组件（内容框架、行框架等）和小程序运行时环境
- **组件层**：核心功能组件、UI组件和小程序公共组件
- **页面层**：核心功能页面和小程序页面

#### 3.1.2 技术栈
- 前端框架：vue + tdesign
- 小程序容器技术：wujie 微前端框架

### 3.2 主要页面布局
#### 3.2.1 登录页面
- **布局结构**：顶部导航栏(含应用logo)、中部登录区域(二维码登录模块和欢迎界面)、底部区域(版本号和版权信息)、右下角背景图
- **设计特点**：简洁登录流程、响应式布局、实时登录状态反馈
- **核心控件**：二维码登录按钮、同意条款复选框、免责声明弹窗

#### 3.2.2 仪表盘页面
- **布局结构**：全屏内容框架(列布局)、欢迎区域(顶部行框架)、动态内容块(多行框架)、左侧底部半透明背景动画图
- **设计特点**：信息展示为主、背景图片增强视觉效果、内容层次清晰

#### 3.2.3 房间管理页面
- **布局结构**：封面设置区域、房间信息区域、弹幕流链接区域、OBS同步设置区域、RTMP设置区域、推流状态区域、下播按钮区域
- **核心控件**：图片上传控件(支持裁剪)、房间标题输入框、直播分区级联选择器、OBS同步开关、推流状态指示器

#### 3.2.4 小程序管理中心
- **布局结构**：顶部导航栏(搜索框和操作按钮)、分类标签栏、卡片式小程序列表、底部状态栏
- **设计特点**：卡片式设计(含图标/名称/描述/评分/状态)、实时状态展示、快速操作按钮、拖拽排序功能

#### 3.2.5 其他关键页面
- **错误页面**：全屏居中容器、错误图标(282x218px)、友好错误提示文本、返回按钮
- **通用设置页面**：模块化设置区域(使用说明/系统/推流工具路径/端口设置/配置文件/缓存/账号缓存)
- **推流监控页面**：左侧房间信息区域(封面/标题/分类/时长)、右侧数据统计区域(观众数/点赞数/香蕉数/AC币)

### 3.3 UI设计风格与特点
#### 3.3.1 颜色方案
- 主色调：蓝色系（#1890ff）
- 背景色：深色背景（黑色或深灰色）
- 文本色：白色和浅灰色（提高可读性）
- 状态色：绿色（在线/成功）、红色（离线/失败）

#### 3.3.2 排版规范
- 字体：系统默认字体，标题加粗
- 字体大小层次：
  - 标题：较大字号（18px+）
  - 正文：中等字号（14px-16px）
  - 辅助文字：较小字号（12px-13px）

#### 3.3.5 组件尺寸规范
- 按钮尺寸：默认40px高度，紧凑型32px，大型48px
- 输入框：统一高度40px，边框半径4px
- 卡片组件：默认阴影2px，悬停时阴影4px
- 图标尺寸：16x16px（紧凑）、24x24px（默认）、32x32px（强调）

#### 3.3.3 组件风格
- 圆角设计：轻微圆角（4px）
- 阴影效果：适度阴影增强层次感
- 悬停效果：按钮和可交互元素有明显的悬停状态变化
- 一致性：相同类型的组件保持统一的设计风格

#### 3.3.4 交互体验
- 表单验证实时反馈
- 操作成功/失败提示
- 加载状态显示
- 平滑过渡动画

### 3.4 响应式设计
- 适配不同屏幕分辨率（1080p、720p、480p等）
- 使用弹性布局实现弹性空间分配
- 部分页面元素根据屏幕尺寸自动调整大小或隐藏

### 3.5 组件库与自定义组件
#### 3.5.1 第三方组件库使用
主要使用第三方组件库，核心组件包括：
- 基础组件：按钮、输入框、开关、勾选框
- 表单组件：表单、选择器、级联选择器、滑块
- 导航组件：选项卡、菜单
- 消息组件：消息提示、对话框、通知
- 布局组件：容器、行、列

#### 3.5.2 自定义组件
项目中开发了多个自定义组件以满足特定需求：
- 弹幕流组件
- 房间列表组件
- 超级聊组件
- 规则引擎组件
- 状态条组件

### 3.6 设计规范
#### 3.6.1 布局规范
- 统一使用内容框架和行框架构建页面结构
- 保持一致的间距和边距（通常为8px、16px）
- 功能相关的元素放在同一区域

#### 3.6.2 颜色规范
- 遵循品牌色体系
- 确保文本与背景的对比度符合无障碍标准
- 状态色使用统一（成功绿色、失败红色、警告黄色）

#### 3.6.3 图标规范
- 使用统一的图标库
- 保持图标风格一致
- 图标大小适中，确保可读性

#### 3.6.4 命名规范
- 组件名称使用帕斯卡命名法
- CSS类名使用短横线命名法
- 文件名称与组件名称保持一致

### 3.7 性能优化
- 组件懒加载
- 图片优化（压缩、懒加载）
- 样式按需加载
- 减少不必要的重绘和回流

### 3.8 未来优化方向
1. 增加更多主题选项（明亮主题、深色主题切换）
2. 进一步优化响应式设计，适配更多设备
3. 提升组件动画流畅度
4. 增强无障碍设计
5. 优化大流量场景下的UI表现（如高并发弹幕）

## 4. 功能模块划分
### 4.1 应用主程序核心模块
#### 4.1.1 仪表盘模块
**功能目标**：为主播提供直播全生命周期数据监控与高效操作入口
**用户场景**：主播日常开播前准备、直播中监控、直播后复盘
**核心功能点**：
- 欢迎信息：
    - 显示主播名称、更新公告等
- 数据看板：
    - 核心指标趋势图：
    - 观众指标：实时在线人数、累计观看人次
    - 互动指标：弹幕数、点赞数、礼物数、礼物金额等
    - 图表类型：基础折线图与柱状图展示

- 快捷操作区：
  **核心功能点**：
  - 可配置快捷工具栏：支持自定义常用功能按钮

#### 4.1.2 用户认证与授权模块
- 多因子认证（密码+扫码登录）


#### 4.1.3 直播管理模块
**功能目标**：提供一站式直播全流程管理能力
**用户场景**：开播前配置、直播中实时管理
**核心功能点**：
- 房间配置中心：
    - 基础信息设置（标题、封面、分区标签）
    - 内容属性控制（剪辑功能开关）

- 推流控制：
    - 推流码生成
    - 推流状态查看
    - 同步开播功能：通过obs-websocket将推流码同步到obs，然后控制obs开播



#### 4.1.4 系统设置模块
**功能目标**：提供灵活的系统级配置与个性化选项
**用户场景**：首次使用初始化、性能优化、界面定制
**核心功能点**：
- 界面个性化：
    **核心功能点**：
    - 主题系统：支持白天与黑夜主题切换

- 性能设置：
  - 缓存管理（手动清理/自动清理策略）

- 高级选项：
  - 日志级别设置（调试/信息/警告/错误）
  - API接口调试模式（供开发人员使用）
  - 数据备份与恢复（配置信息导出/导入）
- 版本信息


### 4.2 小程序系统模块
#### 4.2.1 小程序管理中心
- 小程序发现：分类展示、推荐列表、搜索功能
- 生命周期管理：安装、卸载、启用/禁用

#### 4.2.2 小程序运行机制
- 多显示支持：主窗口集成、独立窗口、OBS插件模式
- 资源加载流程：目录扫描、入口文件解析、配置读取
- 通信机制：基于EventSource的标准化事件总线

## 5. 交互流程设计
### 5.1 核心用户流程
#### 5.1.1 开播流程
1. 启动应用并完成用户认证
2. 进入"直播管理"模块配置房间信息（封面/标题/分区）
3. 复制生成的直播码，手动粘贴到obs/开启自动推流
4. 轮训请求推流接口直到获取到直播流地址，"开始直播"按钮可用
5. 点击“开始直播”
6. 直播中监控指标与互动情况
7. 结束直播并生成数据报告

### 5.2 关键界面流转
- **登录页**→**仪表盘**：完成认证后默认进入
- **仪表盘**→**直播管理**：点击"开始直播"按钮
- **直播管理**→**小程序中心**：直播中可随时添加功能

## 6. 非功能需求
### 6.1 性能需求
- 启动时间<10秒
- 内存占用<200MB（空闲状态）
- CPU占用<10%（常规操作）
- 支持同时运行5个以上小程序

### 6.2 兼容性需求
- 操作系统：Windows 10+/macOS 11+/Linux（Ubuntu 20.04+）
- 分辨率：最低支持1366×768
- 推流软件：OBS 27.0+、Streamlabs OBS

### 6.3 安全需求
- **数据加密**: 所有本地存储的用户数据需采用AES-256加密
- **权限控制**: 实现基于RBAC的权限管理系统
- **安全审计**: 记录所有敏感操作日志，保存至少90天
- **输入验证**: 对所有用户输入实施严格的验证和过滤
- **第三方安全**: 第三方小程序运行在沙箱环境，限制系统资源访问

## 7. 验收标准
### 7.1 功能验收标准
- 核心功能覆盖率100%
- 小程序安装成功率>99%
- 推流连接稳定性>99.5%
- **测试方法**: 
  - 功能测试: 基于场景的黑盒测试，覆盖率≥95%
  - 性能测试: 使用JMeter模拟1000条/秒弹幕负载
  - 安全测试: 进行OWASP Top 10漏洞扫描
  - 兼容性测试: 在Windows 10/11及macOS 12+环境验证
- **通过标准**: 所有测试用例通过率≥98%，无严重缺陷

### 7.2 性能验收标准
- 冷启动时间<10秒
- 直播状态下CPU占用<15%
- 弹幕渲染延迟<300ms

### 7.3 兼容性验收标准
- 在3种主流操作系统上功能正常
- 适配5种常见屏幕分辨率

## 8. 优先级与迭代计划
### 8.1 MVP版本（V1.0)
- 核心功能模块开发完成
- 支持基础弹幕管理
- 实现小程序基础框架

### 8.2 迭代计划
- V1.1: 增加数据分析功能
- V1.2: 扩展小程序生态
- V1.3: 性能优化与多平台适配

## 9. 风险评估
### 9.1 风险评估
- **技术风险**：Electron版本升级可能导致兼容性问题
  - 缓解策略: 建立版本兼容性测试矩阵，保留历史稳定版本回滚通道
- **性能风险**：高并发弹幕处理可能导致界面卡顿
  - 缓解策略: 实现弹幕渲染优先级队列，非关键帧弹幕延迟渲染
- **安全风险**：第三方小程序权限管理不当可能导致数据泄露
  - 缓解策略: 实施细粒度权限控制，敏感操作需用户二次确认
- **依赖风险**：第三方API服务不稳定影响功能可用性
  - 缓解策略: 设计服务降级机制，关键数据本地缓存
- **运营风险**：用户 adoption率低
  - 缓解策略: 提供交互式新手引导与详细功能教程
- **生态风险**：小程序生态发展缓慢
  - 缓解策略: 推出开发者激励计划与完善的开发支持工具